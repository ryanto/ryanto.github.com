<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>EmberJS Testing</title>
  <link rel="stylesheet" 
    href="http://cdnjs.cloudflare.com/ajax/libs/qunit/1.11.0/qunit.min.css">
</head>
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>

  <script type="text/javascript"
    src="http://cdnjs.cloudflare.com/ajax/libs/qunit/1.11.0/qunit.min.js"></script>
  <script type="text/javascript"
    src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.js"></script>
  <script type="text/javascript"
    src="http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.0.0/handlebars.min.js"></script>

  <script type="text/javascript"
    src="http://builds.emberjs.com/ember-1.0.0-rc.7.js"></script>

  <script type="text/x-handlebars" data-template-name="index">
    <h1 class="welcome">Welcome</h1>
    <p class="message">Welcome to my website</p>
  </script>

  <script type="text/x-handlebars" data-template-name="dashboard">
    <h1>Welcome {{username}}</h1>
  </script>

  <script type="text/javascript">
    Ember.Application.initializer({
      name: "currentUser",

      initialize: function(container, application) {
        container.register("current:user", application.User);
        application.inject("controller", "currentUser", "current:user");
      }
    });

    App = Ember.Application.create({
      rootElement: '#qunit-fixture'
    });

    App.Router.map(function() {
      this.resource("dashboard");
    });

    App.User = Ember.Object.extend();

    App.DashboardController = Ember.ObjectController.extend({
      currentUser: null, // injected
      content: Ember.computed.alias('currentUser')
    });

    App.setupForTesting();

    // begin tests

    Ember.Test.registerHelper('assertExists', function(app, selector, times) {
      if (!times) { 
        times = 1;
      }

      return wait()
        .find(selector)
        .then(function(element) {
          equal(element.length, times, "found " + selector + " " + times + "  times");
        });
    });

    Ember.Test.registerHelper("loginAs", function(app, username) {
      return wait()
        .then(function() {
          var currentUser = app.__container__.lookup('current:user');
          currentUser.setProperties({
            username: username,
            loggedIn: true
          });
        });
    });

    module("Testing Helpers", {
      setup: function() {
        App.reset();
        App.injectTestHelpers();
      }
    });

    test("should show a welcome message", function() {
      visit("/")
        .assertExists("p.message");
    });

    test("should automatically login as ryan", function() {
      loginAs("ryan")
        .visit("/dashboard")
        .assertExists("h1:contains('Welcome ryan')");
    });
  </script>
</body>
</html>
